{\rtf1\ansi\ansicpg1252\cocoartf1561\cocoasubrtf200
{\fonttbl\f0\fswiss\fcharset0 Helvetica;}
{\colortbl;\red255\green255\blue255;}
{\*\expandedcolortbl;;}
\paperw11900\paperh16840\margl1440\margr1440\vieww18700\viewh9960\viewkind0
\pard\tx566\tx1133\tx1700\tx2267\tx2834\tx3401\tx3968\tx4535\tx5102\tx5669\tx6236\tx6803\pardirnatural\partightenfactor0

\f0\fs24 \cf0 PATH=$\{PATH\}:/usr/local/bin\
PROJECT_DIR=/Users/jenkins/Documents/fortress\
OUTPUT_DIR=$\{PROJECT_DIR\}/../Builds\
\
BRANCH="$(python -c 'import os; print os.environ["Branch"]')"\
CONFIGURATION="$(python -c 'import os; print os.environ["Configuration"]')"\
UNITY_ARGS="$\{CONFIGURATION\} Release"\
if [ "$\{DEBUG_LOG\}" = true ]; then\
	UNITY_ARGS="$\{UNITY_ARGS\} DEBUG_LOG"\
fi\
\
whoami\
\
echo Synching with GitLab SCM...\
pushd "$\{PROJECT_DIR\}"\
git fetch origin\
git reset --hard origin/$\{BRANCH\}\
popd\
\
echo Copy Info.plist and ProjectSettings.asset ...\
\
cp /Users/jenkins/Documents/Fortress_env/ProjectSettings.asset $\{PROJECT_DIR\}/Fortress_UnityProject/ProjectSettings/\
cp /Users/jenkins/Documents/Fortress_env/Info.plist $\{PROJECT_DIR\}/exportOptionsPlists/\
\
echo Updating assembly info...\
/usr/bin/ruby \\\
$\{PROJECT_DIR\}/Tools/assemblyInfo.rb \\\
-a Fortress \\\
-s Fortress \\\
-v $\{Version\} \\\
-b $\{BUILD_NUMBER\} \\\
-o $\{PROJECT_DIR\}/Fortress_UnityProject/Assets/Game/Properties/AssemblyInfo.cs\
\
echo Creating output folders..\
\
mkdir /Users/jenkins/.jenkins/jobs/Fortress_build/builds/$\{BUILD_NUMBER\}/archive\
\
# iOS build conditional\
if [ "$\{BUILD_IOS\}" = true ]; then\
\
echo Copy Info.plist and ProjectSettings.asset ...\
\
cp /Users/jenkins/Documents/Fortress_env/ProjectSettings.asset $\{PROJECT_DIR\}/Fortress_UnityProject/ProjectSettings/\
cp /Users/jenkins/Documents/Fortress_env/Info.plist $\{PROJECT_DIR\}/exportOptionsPlists/\
\
echo Generating Xcode project with Unity...\
open -na'/Applications/Unity 2017.1.2/Unity.app/Contents/MacOS/Unity' \\\
-projectPath "$\{PROJECT_DIR\}/Fortress_UnityProject" \\\
-quit \\\
-batchmode \\\
-logfile \\\
-buildTarget ios \\\
-executeMethod AutomatedBuild.PerformIOSBuild $\{UNITY_ARGS\}\
\
echo Unlocking the Autobuild keychain for code signing... \
security unlock-keychain -p "1234" "/Users/jenkins/Library/Keychains/login.keychain-db"\
\
# WARNING: Please leave disabled!\
#echo Setting the build number in the Xcode project...\
#/usr/libexec/PlistBuddy -c "Set :CFBundleVersion $\{BUILD_NUMBER\}" "$\{OUTPUT_DIR\}/iOS/Release/Info.plist"\
\
echo Generating Xcode archive...\
xcodebuild \\\
archive \\\
-workspace "$\{OUTPUT_DIR\}/Fortress/iOS/Release/Unity-iPhone.xcworkspace" \\\
-scheme Unity-iPhone \\\
-configuration Distribution \\\
-archivePath "$\{OUTPUT_DIR\}/Xcode_Archive"\
\
echo Generating IPA from archive...\
xcodebuild \\\
-exportArchive \\\
-exportOptionsPlist "$\{PROJECT_DIR\}/exportOptionsPlists/Info.plist" \\\
-exportPath "/Users/jenkins/.jenkins/jobs/Fortress_build/builds/$\{BUILD_NUMBER\}/archive/" \\\
-archivePath "$\{OUTPUT_DIR\}/Xcode_Archive.xcarchive"\
\
echo Renaming IPA file..\
\
mv /Users/jenkins/.jenkins/jobs/Fortress_build/builds/$\{BUILD_NUMBER\}/archive/Unity-iPhone.ipa /Users/jenkins/.jenkins/jobs/Fortress_build/builds/$\{BUILD_NUMBER\}/archive/Fortress_$\{BUILD_NUMBER\}.ipa\
cp /Users/jenkins/.jenkins/jobs/Fortress_build/builds/$\{BUILD_NUMBER\}/archive/Fortress_$\{BUILD_NUMBER\}.ipa /Users/jenkins/.jenkins/workspace/Fortress_build/\
\
\
\
fi\
\
# Android build conditional\
if [ "$\{BUILD_ANDROID\}" = true ]; then\
\
echo Generating Android project with Unity...\
open -na'/Applications/Unity 2017.1.2/Unity.app/Contents/MacOS/Unity' \\\
-projectPath "$\{PROJECT_DIR\}/Fortress_UnityProject" \\\
-quit \\\
-batchmode \\\
-logfile \\\
-buildTarget android \\\
-executeMethod AutomatedBuild.PerformAndroidBuild $\{UNITY_ARGS\}\
\
echo building Android Studio project...\
cp -avf $\{PROJECT_DIR\}/Tools/build/gradle/* $\{OUTPUT_DIR\}/Fortress/Android/Release/COG/\
pushd $\{OUTPUT_DIR\}/Fortress/Android/Release/COG\
sudo chmod 777 gradlew\
./gradlew assembleRelease\
\
echo Renaming and Moving Android APK...\
\
mkdir /Users/jenkins/.jenkins/jobs/Fortress_build/builds/$\{BUILD_NUMBER\}/archive/com.goea.fortress\
\
mv /Users/jenkins/Documents/Builds/Fortress/Android/Release/COG/build/outputs/apk/COG-release.apk /Users/jenkins/.jenkins/jobs/Fortress_build/builds/$\{BUILD_NUMBER\}/archive/Fortress_$\{BUILD_NUMBER\}.apk\
mv /Users/jenkins/Documents/Builds/Fortress/Android/Release/COG/COG.main.obb /Users/jenkins/.jenkins/jobs/Fortress_build/builds/$\{BUILD_NUMBER\}/archive/com.goea.fortress/main.$\{BUILD_NUMBER\}.com.goea.fortress.obb\
\
popd\
\
fi}